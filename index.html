<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“7æ—¥é–“å‘¨éŠï¼ˆå…±æœ‰ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <h1>â„ï¸ åŒ—æµ·é“æ—…ã®ã—ãŠã‚Š â„ï¸</h1>
        <div class="header-controls">
            <button onclick="toggleEditMode()" id="editBtn" class="btn-edit">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
        </div>
    </header>

    <nav class="sticky-nav">
        <div class="nav-scroller" id="dayTabs">
            </div>
    </nav>

    <main id="scheduleContainer">
        <p style="text-align:center; margin-top:50px; color:#666;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â–¼â–¼â–¼ ã‚ãªãŸã®è¨­å®šæƒ…å ±ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã—ãŸ â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyD38ppWWbKL2TelivqqpxiUcYd9PRW1RPo",
            authDomain: "hokkaido-trip-cacb9.firebaseapp.com",
            databaseURL: "https://hokkaido-trip-cacb9-default-rtdb.firebaseio.com",
            projectId: "hokkaido-trip-cacb9",
            storageBucket: "hokkaido-trip-cacb9.firebasestorage.app",
            messagingSenderId: "836754090370",
            appId: "1:836754090370:web:a5e8ece492a1e13f0d879b"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚¸ãƒƒã‚¯ ---

        // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã®ã¨ãã ã‘ä½¿ã‚ã‚Œã¾ã™ï¼‰
        const defaultData = [
            { day: 1, title: "æ–°åƒæ­³ãƒ»å‡½é¤¨", events: [{ time: "09:00", title: "æ–°åƒæ­³ç©ºæ¸¯ ç€", desc: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼æ‰‹ç¶šã" }, { time: "12:00", title: "ãƒ©ãƒ³ãƒ", desc: "è‹«å°ç‰§ã§ãƒ›ãƒƒã‚­ã‚«ãƒ¬ãƒ¼" }] },
            { day: 2, title: "å‡½é¤¨ãƒ»ç™»åˆ¥", events: [{ time: "08:00", title: "å‡½é¤¨æœå¸‚", desc: "ã‚¤ã‚«é‡£ã‚Šä½“é¨“" }] },
            { day: 3, title: "æœ­å¹Œãƒ»å°æ¨½", events: [] },
            { day: 4, title: "æ—­å·ãƒ»ç¾ç‘›", events: [] },
            { day: 5, title: "ç¶²èµ°ãƒ»æµæ°·", events: [] },
            { day: 6, title: "é“æ±ãƒ»é‡§è·¯", events: [] },
            { day: 7, title: "å¸¯åºƒãƒ»å¸°è·¯", events: [] }
        ];

        let appData = [];
        let isEditMode = false;
        let currentActiveDay = 1;

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‚ç…§å…ˆ
        const dataRef = ref(db, 'trip/hokkaido');

        // â˜…ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸå‡¦ç†
        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
                appData = data;
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ä½¿ã†
                appData = defaultData;
                set(dataRef, defaultData);
            }
            // ç”»é¢ã‚’æ›´æ–°
            renderTabs();
            renderSchedule();
        });

        // ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜
        window.saveToCloud = function() {
            set(dataRef, appData)
                .then(() => {
                    console.log("Saved successfully!");
                })
                .catch((error) => {
                    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error);
                });
        };

        // --- UIæ“ä½œé–¢æ•° (windowã«ç´ä»˜ã‘) ---

        window.switchDay = function(dayNum) {
            currentActiveDay = dayNum;
            renderTabs();
            renderSchedule();
        }

        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('editBtn');
            if (isEditMode) {
                btn.innerText = "ğŸ’¾ ä¿å­˜ã—ã¦å®Œäº†";
                btn.style.background = "#e91e63";
                btn.style.color = "white";
            } else {
                window.saveToCloud(); // ç·¨é›†çµ‚äº†æ™‚ã«ä¿å­˜
                btn.innerText = "âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
                btn.style.background = "white";
                btn.style.color = "#0076a8";
            }
            renderSchedule();
        }

        // å…¥åŠ›å€¤ã®æ›´æ–°å‡¦ç†
        window.updateDayTitle = (day, val) => {
            appData.find(d => d.day === day).title = val;
        };
        window.updateEvent = (day, idx, field, val) => {
            appData.find(d => d.day === day).events[idx][field] = val;
        };
        window.addEvent = (day) => {
            appData.find(d => d.day === day).events.push({time:"10:00", title:"æ–°è¦äºˆå®š", desc:""});
            renderSchedule(); // å³åº§ã«å†æç”»
        };
        window.deleteEvent = (day, idx) => {
            if(confirm("ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                appData.find(d => d.day === day).events.splice(idx, 1);
                renderSchedule();
            }
        };

        // --- æç”»é–¢æ•° ---

        function renderTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            appData.forEach(dayData => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${dayData.day === currentActiveDay ? 'active' : ''}`;
                btn.innerText = `Day ${dayData.day}`;
                btn.onclick = () => window.switchDay(dayData.day);
                container.appendChild(btn);
            });
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            appData.forEach(dayData => {
                const section = document.createElement('div');
                section.className = `day-section ${dayData.day === currentActiveDay ? 'active' : ''}`;
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç·¨é›†æ™‚ã¯å…¥åŠ›æ¬„ï¼‰
                let headerHTML = isEditMode ? 
                    `<div class="day-title"><input type="text" class="edit-input" value="${dayData.title}" onchange="updateDayTitle(${dayData.day}, this.value)" style="font-weight:bold; font-size:1.2rem;"></div>` :
                    `<div class="day-title"><h2>${dayData.day}æ—¥ç›®ï¼š${dayData.title}</h2></div>`;

                let eventsHTML = `<div class="timeline">`;
                
                dayData.events.forEach((evt, idx) => {
                    if (isEditMode) {
                        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                        eventsHTML += `
                        <div class="event">
                            <div class="detail" style="border:1px solid #0076a8; background:#f0f8ff;">
                                <div style="display:flex; gap:5px; margin-bottom:5px;">
                                    <input type="time" class="edit-input" value="${evt.time}" onchange="updateEvent(${dayData.day}, ${idx}, 'time', this.value)" style="width:30%;">
                                    <input type="text" class="edit-input" value="${evt.title}" onchange="updateEvent(${dayData.day}, ${idx}, 'title', this.value)" style="width:70%;">
                                </div>
                                <textarea class="edit-input" onchange="updateEvent(${dayData.day}, ${idx}, 'desc', this.value)" placeholder="ãƒ¡ãƒ¢...">${evt.desc}</textarea>
                                <button onclick="deleteEvent(${dayData.day}, ${idx})" style="color:red; background:none; border:none; margin-top:5px; cursor:pointer;">ğŸ—‘ å‰Šé™¤</button>
                            </div>
                        </div>`;
                    } else {
                        // é–²è¦§ãƒ¢ãƒ¼ãƒ‰
                        eventsHTML += `
                        <div class="event">
                            <span class="time">${evt.time}</span>
                            <div class="detail">
                                <h3 class="event-title">${evt.title}</h3>
                                <p class="event-desc">${evt.desc}</p>
                            </div>
                        </div>`;
                    }
                });

                if (isEditMode) {
                    eventsHTML += `<button class="add-event-btn" onclick="addEvent(${dayData.day})">ï¼‹ äºˆå®šã‚’è¿½åŠ </button>`;
                }
                
                eventsHTML += `</div>`;
                section.innerHTML = headerHTML + eventsHTML;
                container.appendChild(section);
            });
        }
    </script>
</body>
</html>
